// Generated by CoffeeScript 1.6.3
(function() {
  var OssEasy, fs, generateRandomId, ossAPI, _;

  _ = require("underscore");

  ossAPI = require('oss-client');

  fs = require("fs");

  generateRandomId = function() {
    return "" + ((Math.random() * 36 >> 0).toString(36)) + ((Math.random() * 36 >> 0).toString(36)) + (Date.now().toString(36));
  };

  OssEasy = (function() {
    function OssEasy(key, secret, targetBucket) {
      this.targetBucket = targetBucket;
      this.oss = new ossAPI.OssClient({
        accessKeyId: key,
        accessKeySecret: secret
      });
    }

    OssEasy.prototype.readFile = function(filename, options, callback) {
      var pathToTempFile;
      pathToTempFile = "/tmp/" + (generateRandomId());
      this.downloadFile(filename, pathToTempFile, function(err) {
        if (err != null) {
          return callback(err);
        } else {
          return fs.readFile(pathToTempFile, options, callback);
        }
      });
    };

    OssEasy.prototype.writeFile = function(filename, data, callback) {
      var pathToTempFile,
        _this = this;
      pathToTempFile = "/tmp/" + (generateRandomId());
      fs.writeFile(pathToTempFile, data, function(err) {
        if (err != null) {
          return callback(err);
        } else {
          return _this.uploadFile(filename, pathToTempFile, callback);
        }
      });
    };

    OssEasy.prototype.uploadFile = function(filename, pathToFile, callback) {
      var args;
      args = {
        bucket: this.targetBucket,
        object: filename,
        srcFile: pathToFile
      };
      this.oss.putObject(args, callback);
    };

    OssEasy.prototype.downloadFile = function(filename, pathToFile, callback) {
      var args;
      args = {
        bucket: this.targetBucket,
        object: filename,
        dstFile: pathToFile
      };
      this.oss.getObject(args, callback);
    };

    return OssEasy;

  })();

  exports.init = function(key, secret, bucketName) {
    if (!(_.isString(key) && _.isString(secret) && _.isString(bucketName) && key.length > 0 && secret.length > 0 && bucketName.length > 0)) {
      throw new Error("Invalid arguments. key:" + key + ", secret:" + secret + ", bucket:" + bucketName);
    }
    return new OssEasy(key, secret, bucketName);
  };

}).call(this);
